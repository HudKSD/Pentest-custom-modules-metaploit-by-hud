# ======================================================================
# SCAN PLAYBOOK SCRIPT SETTINGS
# ======================================================================
# Hud_Custom_Scanner_reloaded.rc
# Author: Hud Seidu Daannaa (Web: www.daannaa.space)
# 
# This Metasploit RC-File could be used to portscan the network via 
# nmap or via the internal portscanner module 

# RHOSTS is used from the global datastore
# PORTS is used from the global datastore

# https://secwiki.org/w/Running_nmap_as_an_unprivileged_user
# chmod 777 /usr/bin/nmap
# sudo setcap cap_net_raw,cap_net_admin,cap_net_bind_service+eip /usr/bin/nmap
# ======================================================================

<ruby>
#DB_STATUS_CHECK
begin
	framework.db.hosts
rescue ::ActiveRecord::ConnectionNotEstablished
	print_error("Database connection isn't established")
	return
end

#PORTS
common_ports = '1-1024'
all_ports = '1-65535'
custom_ports_0 = '21,22,23,25,43,50,53,67,68,79,80,109,110,111,123,135,137,138,139,143,161,264,265,389,443,445'
custom_ports_1 = '500,631,901,995,1241,1352,1433,1434,1521,1720,1723,3306,3389,3780,4662,5800,5801,5802,5803'
custom_ports_2 = '5900,5901,5902,5903,6000,6666,8000,8080,8443,10000,10043,27374,27665'
all_custom = '1-27665'
custom_5 = '1-4662'

#SPECIFY OPERATIONS
#this section is used to run nmap or modules
#ops = ['nmap','modules_']
ops = ['nmap']
for num in ops do
    if ( num == 'nmap' )
        print_line(" ")
        print_status("Operations 1 activated")
		print_status("Hence, NMAP is activated")
        op1 = 1
    elsif ( num == 'module' )
        print_status("Operations 2 activated")
		print_status("Hence, Modules is activated")
        op2 = 1
    else
        print_status("You are not ready ...")
        print_line(" ")
    end
end  

#GLOBAL_PARAMETERS
rhosts = #'212.123.6.254'
ports =  custom_5
run_single("setg PORTS #{ports}")
run_single("setg RHOSTS #{rhosts}")

#PARAMETER VALIDATION
print_line(" ")
print_line("[+] Parameter Validation ")
print_line(" ")
#Rhosts
if (framework.datastore['RHOSTS'] == nil)
	print_status("You have to set RHOSTS globally ... exiting")
	return
end
#Ports
if (framework.datastore['PORTS'] == nil)
	print_status("You have to set PORTS globally ...")
    print_status("Will use default settings ...")
	#return
else
    ports = all_ports
    run_single("setg PORTS #{ports}")  
end

#INTRODUCTION
print_line(" ")
print_line("Hud_Custom_Scanner_reloaded.rc")
print_line("Author: Hud Seidu Daannaa | Web: www.daannaa.space")
print_line("Starting scanner ...")
print_line(" ")

if (op1 == 'nmap')
	#OPERATION
	print_line(" ")
	print_status("The section of this script runs Nmap flags, one after the other ...")
	print_line(" ")

	scan_types = ['sA','sF','sS','sW','sX','sU','sT']
	
	counter = 0
	for scan in scan_types do
		counter = counter + 1
		print_line(" ")
		print_status("OPERATION: #{counter}, Uses Nmap options: #{scan}")
		print_line(" ")
		print_status("Module: Db_Nmap")
		nmap_type = "Nmap scan: #{scan}"
		#nmapopts = "-#{scan} -Pn --reason -sV --version-light  --privileged "
		nmapopts = "-#{scan} -Pn -sV -O --osscan-guess -O --osscan-limit -T4 --privileged --host-timeout 10m"
		run_single("workspace -a #{nmap_type}")
		print_ststus("Workspace created ...")
		print_line("[-] #{nmap_type} is loading ...")
		print_line("[-] =======================================")
		print_line("[-] Applying Huds Custom Scripts, Switches & Settings")
		print_status("Nmap Options: #{nmapopts}")
		print_line("[-] Target: #{framework.datastore['RHOSTS']}")
		print_line(" ")
		run_single("db_nmap #{framework.datastore['RHOSTS']} -p#{framework.datastore['PORTS']} #{nmapopts}")
		print_status("Done ...")
		print_status("_________________________________________")
	end
end

if (op1 == 'modules_')
	#MSF MODULE OPERATION
	#msfconsole's aux scanners
	print_line(" ")
	print_status("The section of this script runs msf's auxiliary scanner modules, one after the other ...")
	print_line(" ")

	modules = ['auxiliary/scanner/portscan/tcp']
	
	counter = 0
	for module_ in modules do
		counter = counter + 1
		print_line(" ")
		print_status("OPERATION: #{counter}")
		print_line(" ")
		print_line("Module: #{module_}")
		run_single("workspace -a #{module_}")
		print_line("[-] Workspace created ...")
		print_line("[-] Loading ...")
		print_line("[-] =======================================")
		print_line("[-] Applying Huds Custom Scripts, Switches & Settings")
		print_line("[-] Target: #{framework.datastore['RHOSTS']}")
		run_single("use #{module_}")
		run_single("set PORTS {framework.datastore['PORTS']}")    
		run_single("run -j")
		run_single("back")
		print_status("Please check jobs ...")
		print_status("_________________________________________")
	end
end
</ruby>